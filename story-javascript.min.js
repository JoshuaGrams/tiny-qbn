State.initPRNG();var QBN={};window.QBN=QBN,QBN.cards={};for(var cardTags=['card','sticky-card'],i=0;i<cardTags.length;++i)for(var title,sel='tw-passagedata[tags~='+cardTags[i]+']',c=document.querySelectorAll(sel),j=0;j<c.length;++j)title=c[j].getAttribute('name'),QBN.cards[title]=i;$(document).on(':passagestart',function(a){var b=a.passage.title;0===QBN.cards[b]&&delete QBN.cards[b]}),QBN.passages=function(a){return void 0===a&&(a={}),Story.lookupWith(function(b){return QBN.passageMatches(b,a)})},QBN.functions=[{match:/^not-(.+)/,action:function(a,b){return!QBN.has(a[1],b)}},{match:/^random-([0-9]+)/,action:function(a){return State.random()<a[1]/100}}],QBN.rangeTag=function(a,b){for(var c=State.getVar(a),d=0;d<b.length;d+=2){var e=b[d],f=b[d+1];if(void 0===f||c<f)return void State.setVar('_'+a.substring(1)+e,!0)}},QBN.has=function(a,b){for(var c=State.variables,d=State.temporary,e=null,f=0;f<QBN.functions.length;++f){var g=QBN.functions[f],h=g.match.exec(a);if(h){e=g.action(h,b);break}}return null===e&&(e=b[a]||d[a]||c[a]),!!e},QBN.passageMatches=function(a,b){if(null==QBN.cards[a.title])return!1;for(var c=0;c<a.tags.length;++c){var d=a.tags[c],e=/^req-/.exec(d);if(e)d=d.substring(e[0].length);else continue;if(!QBN.has(d,b))return!1}return!0},Macro.add('addcard',{handler:function(){var a=Story.lookup(this.args[0]);return a?void(QBN.cards[a.title]=this.args[1]?1:0):this.error('No such passage "'+this.args[0]+'".')}}),Macro.add('removecard',{handler:function(){null!=QBN.cards[this.args[0]]&&delete QBN.cards[this.args[0]]}});function list(a){return'object'!=typeof a||null==a.length?[a]:a}function groupOrSeparator(a,b){var c,d=/^separator:/.exec(a);if(d)c=a.substring(d[0].length);else{var e='qbn-cards__'+(null==a?'vertical':a);c=$('<div/>',{class:e+' qbn-cards'}),c.appendTo(b)}return c}function cardElement(a,b,c,d,e){var f;if('string'==typeof a)f=b,c===d-1&&', '===a&&(a=' and '),0<c&&f.append(document.createTextNode(a));else{var g={class:'qbn-card'};e&&(g.class+=' '+e.domId,g['data-passage']=e.title),f=$('<div/>',g),f.appendTo(a)}return f}Macro.add('includecards',{handler:function(){for(var a,b=list(this.args[0]),c=groupOrSeparator(this.args[1],this.output),d=0;d<b.length;++d){a=b[d],'string'==typeof a&&(a=Story.get(a)),0===QBN.cards[a.title]&&delete QBN.cards[a.title];var e=cardElement(c,this.output,d,b.length,a);e.wiki(a.processText())}}}),Macro.add('linkcards',{handler:function(){var a=list(this.args[0]),b=groupOrSeparator(this.args[1]);'string'!=typeof b&&b.appendTo(this.output);for(var c=0;c<a.length;++c){var d=a[c],e=cardElement(b,this.output,c,a.length);'string'!=typeof d&&(d=d.title),Wikifier.createInternalLink(e,d,d)}}});

