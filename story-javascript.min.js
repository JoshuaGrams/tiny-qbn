State.initPRNG();var QBN={};window.QBN=QBN;function resetDeck(){for(var a={},b=["card","sticky-card"],d=0;d<b.length;++d)for(var e,f="tw-passagedata[tags~="+b[d]+"]",g=document.querySelectorAll(f),c=0;c<g.length;++c)e=g[c].getAttribute("name"),a[e]=d;State.setVar("$QBN_deck",a)}resetDeck(),$(document).on(":passagestart",function(a){var b=a.passage.title,c=State.getVar("$QBN_deck");0===c[b]&&delete c[b]});function choose(a,b){var c=Math.min;b=c(b,a.length);for(var d=c(b,a.length-b),e=d==b,f=[],g={},h=0;h<d;){var j=Math.floor(State.random()*a.length);g[j]===void 0&&(e&&f.push(a[j]),g[j]=!0,++h)}if(!e)for(j=0;j<a.length;++j)!0!==g[j]&&f.push(a[j]);return f}QBN.passages=function(a,b){void 0===b&&(b={});var c=Story.lookupWith(function(a){return QBN.passageMatches(a,b)});return a&&(c=choose(c,a)),c};var operators={eq:function(c,a){return c===a},lt:function(c,a){return c<a},gt:function(c,a){return c>a},le:function(c,a){return c<=a},ge:function(c,a){return c>=a}};QBN.functions=[{match:/^not-(.+)/,action:function(a,b){return!QBN.has(a[1],b)}},{match:/^random-([0-9]+)/,action:function(a){return State.random()<a[1]/100}},{match:/^(.*)-([eq|lt|gt|le|ge])-(-?[0-9_]+)/,action:function(a,b){var c=+QBN.value(a[1],b),d=operators[a[2]],e=+a[3].replace("_",".");return d(c,e)}}],QBN.range=function(a,b){if("string"!=typeof a){var c="QBN.range: name must be a string";throw c+=" (got "+typeof a+").",new Error(c)}if(!/^[$_][_a-zA-Z][_a-zA-Z0-9]+$/.test(a)){var c="QBN.range: invalid name "+JSON.stringify(a)+".";throw new Error(c)}var d=b.length;if("number"!=typeof d||3>d||1!=d%2){var c="QBN.range: invalid range spec:";throw c+=" must have at least three values and an odd number",c+=" (got "+JSON.stringify(d)+").",new Error(c)}var e=State.getVar(a);if("undefined"==typeof e){var c="QBN.range: no such variable "+JSON.stringify(a)+".";throw new Error(c)}for(var f,g=0;g<b.length;g+=2){var h=b[g],j=b[g+1];if("string"!=typeof h||"number"!=typeof j&&"undefined"!=typeof j){var c="QBN.range: invalid range spec "+JSON.stringify(b);throw c+=": must alternate names and numbers.",new Error(c)}if("undefined"!=typeof j&&"undefined"!=typeof f&&j<=f){var c="QBN.range: invalid range spec "+JSON.stringify(b);throw c+=": numbers must be strictly increasing.",new Error(c)}if("undefined"==typeof j||e<j)return void State.setVar("_"+h+"_"+a.substring(1),!0);f=j}},QBN.value=function(a,b){var c=State.variables,d=State.temporary,e=b[a];return null==e&&(e=d[a]),null==e&&(e=c[a]),e},QBN.has=function(a,b){for(var c=State.variables,d=State.temporary,e=null,f=0;f<QBN.functions.length;++f){var g=QBN.functions[f],h=g.match.exec(a);if(h){e=g.action(h,b);break}}return null===e&&(e=b[a]||d[a]||c[a]),!!e},QBN.passageMatches=function(a,b){var c=State.getVar("$QBN_deck");if(null==c[a.title])return!1;for(var d=0;d<a.tags.length;++d){var e=a.tags[d],f=/^req-/.exec(e);if(f)e=e.substring(f[0].length);else continue;if(!QBN.has(e,b))return!1}return!0},Macro.add("addcard",{handler:function(){var a=this.args[0],b=this.args[1];if(!Story.has(a))return this.error("No such passage \""+a+"\".");var c=State.getVar("$QBN_deck");c[a]=b?1:0}}),Macro.add("removecard",{handler:function(){var a=State.getVar("$QBN_deck");null!=a[this.args[0]]&&delete a[this.args[0]]}});function list(a){return"object"!=typeof a||null==a.length?[a]:a}Macro.add("includeall",{handler:function(){for(var a,b=list(this.args[0]),c=this.args[1],d=$(this.output),e=State.getVar("$QBN_deck"),f=0;f<b.length;++f)a=b[f],"string"==typeof a&&(a=Story.get(a)),0===e[a.title]&&delete e[a.title],c?d.wiki("<<"+c+" "+a.title+" "+f+" "+b.length+">>"):d.wiki(a.processText())}});